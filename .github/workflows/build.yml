name: Build EXE

on:
  push:
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  release:
    types: [published]

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up PHP for PHAR build
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer, box

    - name: Install xsd2php dependencies
      run: composer install --working-dir=xsd2php-build --no-progress --prefer-dist --no-interaction

    - name: Build xsd2php.phar
      run: |
        cd xsd2php-build
        box compile --no-parallel

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m venv .venv
        ./.venv/Scripts/python -m pip install --upgrade pip
        ./.venv/Scripts/pip install pyinstaller xsdata click jinja2 toposort ruff pillow

    - name: Build EXE
      run: |
        ./.venv/Scripts/pyinstaller exe.spec

    - name: Place xsd2php.phar inside bundle
      run: |
        New-Item -ItemType Directory -Force -Path dist\XSDtoCODE\_internal
        Copy-Item -Path xsd2php.phar -Destination dist\XSDtoCODE\_internal\xsd2php.phar -Force

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: XSDtoCODE-EXE
        path: dist/XSDtoCODE/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: XSDtoCODE-EXE
        path: XSDtoCODE-EXE/

    - name: Create ZIP
      run: |
        zip -r XSDtoCODE-${{ github.ref_name }}.zip XSDtoCODE-EXE/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          Versi√≥n ${{ github.ref_name }} de XSDtoCODE.
          
          Descarga el EXE empaquetado desde los assets.
        draft: false
        prerelease: false
        files: ./XSDtoCODE-${{ github.ref_name }}.zip
